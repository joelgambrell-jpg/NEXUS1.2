<!-- =========================
     equipment.html
     FULL DROP-IN
     - Progress bar (tasks only)
     - Energization tab unlocks at 100% (neon blue + radiating lightning)
     - Reference & Check Sheets bubble (no completion/progress)
     - Energization Goal Date + Countdown
     - Optional Firebase sync:
         * steps sync across devices (Firestore equipment/{eq}/steps/{stepId})
         * goal date + notification emails sync across devices (Firestore equipment/{eq})
     ========================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Equipment</title>

<style>
  :root{
    --bg:#b60000;
    --panel:rgba(255,255,255,0.25);
    --btn-bg:#ffffffdd;
    --btn-color:#000;
    --btn-hover-bg:#fff;
    --btn-hover-color:#b60000;

    /* Energization blue */
    --neon-blue:#00c8ff;
    --neon-blue-dark:#004b66;
  }

  html,body{ margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:var(--bg); }
  .page-wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:40px; }
  main.container{
    width:100%; max-width:960px; background:var(--panel); padding:28px; border-radius:18px;
    backdrop-filter: blur(6px); text-align:center;
  }

  h1{ margin:0 0 8px; font-size:34px; }
  .eq{ font-size:20px; font-weight:900; margin:0 0 18px; }

  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }

  .btn{
    width:100%; height:60px;
    background:var(--btn-bg); color:var(--btn-color);
    border:2px solid #ff0000;
    border-radius:12px;
    font-size:15px; font-weight:700;
    cursor:pointer;
    display:inline-flex; justify-content:center; align-items:center;
    text-decoration:none;
    transition:0.2s;
    box-shadow:0 0 12px #ff0000;
    position:relative;
  }
  .btn:hover{ background:var(--btn-hover-bg); color:var(--btn-hover-color); transform:translateY(-2px); }

  .btn.complete{
    background:#00ff66 !important;
    color:#002b14 !important;
    border-color:#00ff66 !important;
    box-shadow:0 0 14px rgba(0,255,102,.85) !important;
  }

  .btn.locked{
    opacity:0.55;
    cursor:not-allowed;
    transform:none !important;
  }

  /* ===== Progress Bar ===== */
  .progress-wrap{ margin:10px 0 14px; text-align:left; }
  .progress-label{
    font-weight:900;
    margin:0 0 8px;
    display:flex; justify-content:space-between;
    gap:10px;
  }
  .progress-track{
    width:100%; height:16px;
    border-radius:999px;
    background:rgba(0,0,0,0.28);
    border:1px solid rgba(255,255,255,0.22);
    overflow:hidden;
  }
  .progress-fill{
    height:100%; width:0%;
    background:#00ff66;
    box-shadow:0 0 12px rgba(0,255,102,.75);
    transition:width .25s ease;
  }

  /* ===== Bubble ===== */
  .bubble{
    margin-top:18px;
    padding:16px;
    border-radius:18px;
    background:rgba(0,0,0,0.18);
    border:1px solid rgba(255,255,255,0.20);
    text-align:left;
  }
  .bubble-title{ font-weight:900; margin:0 0 12px; }
  .bubble-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }
  .bubble .btn{ height:54px; }

  /* =========================
     Energization (25% larger + neon blue)
     ========================= */
  #energizationWrap{
    position:relative;
    display:inline-block;
    margin:12px 0 18px;
  }

  #energizationBtn{
    height:55px;
    padding:0 18px;
    font-size:16px;
    font-weight:900;
    border-radius:999px;
    overflow:visible;
    z-index:2;
  }

  #energizationBtn.unlocked{
    background:var(--neon-blue) !important;
    color:var(--neon-blue-dark) !important;
    border-color:var(--neon-blue) !important;
    box-shadow:
      0 0 14px rgba(0,200,255,.95),
      0 0 32px rgba(0,200,255,.75);
    animation:energizeGlow 1.5s infinite ease-in-out;
  }

  @keyframes energizeGlow{
    0%{
      box-shadow:
        0 0 10px rgba(0,200,255,.75),
        0 0 22px rgba(0,200,255,.55);
    }
    50%{
      box-shadow:
        0 0 18px rgba(0,200,255,1),
        0 0 40px rgba(0,200,255,.85);
    }
    100%{
      box-shadow:
        0 0 10px rgba(0,200,255,.75),
        0 0 22px rgba(0,200,255,.55);
    }
  }

  /* Radiating lightning */
  .radiate{
    position:absolute;
    inset:0;
    pointer-events:none;
    z-index:1;
    display:none;
  }
  #energizationBtn.unlocked + .radiate{ display:block; }

  .bolt{
    position:absolute;
    left:50%;
    top:50%;
    width:2px;
    height:18px;
    background:rgba(220,245,255,.95);
    box-shadow:0 0 10px rgba(200,240,255,.9);
    transform-origin:50% 100%;
    opacity:0;
  }

  @keyframes radiateOut{
    0%{ opacity:0; transform:translate(-50%,-50%) rotate(var(--a)) translateY(0); }
    15%{ opacity:1; }
    60%{ transform:translate(-50%,-50%) rotate(var(--a)) translateY(calc(-1 * var(--d))); }
    100%{ opacity:0; transform:translate(-50%,-50%) rotate(var(--a)) translateY(calc(-1 * (var(--d) + 18px))); }
  }

  .b1{--a:0deg;--d:26px;animation:radiateOut 1.1s infinite;}
  .b2{--a:45deg;--d:28px;animation:radiateOut 1.2s infinite .1s;}
  .b3{--a:90deg;--d:26px;animation:radiateOut 1.0s infinite .2s;}
  .b4{--a:135deg;--d:28px;animation:radiateOut 1.25s infinite .05s;}
  .b5{--a:180deg;--d:26px;animation:radiateOut 1.15s infinite .18s;}
  .b6{--a:225deg;--d:28px;animation:radiateOut 1.3s infinite .28s;}
  .b7{--a:270deg;--d:26px;animation:radiateOut 1.05s infinite .14s;}
  .b8{--a:315deg;--d:28px;animation:radiateOut 1.2s infinite .24s;}

  /* ===== Goal + Countdown ===== */
  .goal-card{
    margin: 10px 0 18px;
    padding: 14px 16px;
    border-radius: 18px;
    background: rgba(0,0,0,0.18);
    border: 1px solid rgba(255,255,255,0.20);
    text-align:left;
  }
  .goal-title{
    font-weight:900;
    margin:0 0 10px;
    letter-spacing:0.02em;
  }
  .goal-row{ margin:10px 0; }
  .goal-label{
    display:block;
    font-weight:900;
    margin:0 0 6px;
    font-size:13px;
    opacity:.95;
  }
  .goal-input{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.18);
    outline:none;
    font-size:15px;
    background: rgba(255,255,255,0.92);
    color:#111;
    font-weight:800;
  }
  .goal-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .goal-btn{
    padding:10px 14px;
    border-radius:999px;
    font-weight:900;
    cursor:pointer;
    border:2px solid rgba(255,255,255,0.35);
    background: rgba(0,0,0,0.20);
    color:#fff;
  }
  .goal-btn.secondary{ opacity:.9; }
  .countdown{
    margin-top:12px;
    padding-top:10px;
    border-top:1px solid rgba(255,255,255,0.18);
  }
  .countdown-big{ font-weight:900; font-size:18px; }
  .countdown-sub{
    margin-top:4px;
    font-weight:800;
    opacity:.9;
    font-size:13px;
  }
</style>
</head>

<body>
<div class="page-wrap">
<main class="container">

  <h1>Equipment Page</h1>
  <div class="eq" id="eqLabel"></div>

  <div class="progress-wrap">
    <div class="progress-label">
      <div id="progressText">Progress: 0%</div>
      <div id="progressCount">0/0</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- ===== Energization Goal + Countdown ===== -->
  <div class="goal-card" id="goalCard">
    <div class="goal-title">Energization Goal</div>

    <div class="goal-row">
      <label class="goal-label" for="goalDate">Goal Date &amp; Time</label>
      <input class="goal-input" id="goalDate" type="datetime-local" />
    </div>

    <div class="goal-row">
      <label class="goal-label" for="notifyEmails">Notify Emails (comma-separated)</label>
      <input class="goal-input" id="notifyEmails" type="text" placeholder="foreman@company.com, pm@company.com" />
    </div>

    <div class="goal-actions">
      <button class="goal-btn" id="saveGoalBtn" type="button">Save Goal</button>
      <button class="goal-btn secondary" id="clearGoalBtn" type="button">Clear</button>
    </div>

    <div class="countdown">
      <div class="countdown-big" id="countdownBig">No goal set</div>
      <div class="countdown-sub" id="countdownSub"></div>
    </div>
  </div>

  <div id="energizationWrap">
    <a class="btn locked" id="energizationBtn" href="#" aria-disabled="true">Energization</a>
    <div class="radiate">
      <span class="bolt b1"></span><span class="bolt b2"></span>
      <span class="bolt b3"></span><span class="bolt b4"></span>
      <span class="bolt b5"></span><span class="bolt b6"></span>
      <span class="bolt b7"></span><span class="bolt b8"></span>
    </div>
  </div>

  <div class="grid">
    <a class="btn" id="rifBtn">RIF</a>
    <a class="btn" id="lvtBtn">Megohmmeter Testing</a>
    <a class="btn" id="torqueBtn">Torque</a>
    <a class="btn" id="l2Btn">L2-IVF</a>
    <a class="btn" id="prefodBtn">Pre-FOD</a>
    <a class="btn" id="finishedPhotoBtn">Finished Product Verification Photo</a>
  </div>

  <div class="bubble">
    <div class="bubble-title">Reference &amp; Check Sheets</div>
    <div class="bubble-grid">
      <a class="btn" id="constructionBtn">Construction Check Sheet</a>
      <a class="btn" id="phenolicBtn">Phenolic Display</a>
      <a class="btn" id="transformerBtn">Diagram Image</a>
      <a class="btn" id="supportingBtn">Supporting Documents</a>
    </div>
  </div>

</main>
</div>

<!-- OPTIONAL (recommended): include your Firebase init that sets window.NEXUS_FB = { db, auth } -->
<!-- <script type="module" src="firebase.js"></script> -->

<script>
(function () {
  const qs = new URLSearchParams(location.search);
  const eq = (qs.get("eq") || "").trim();

  const eqLabel = document.getElementById("eqLabel");
  if (eqLabel) eqLabel.textContent = eq ? `Equipment: ${eq}` : "Missing equipment ID";

  function link(id){
    return `task.html?id=${encodeURIComponent(id)}${eq ? `&eq=${encodeURIComponent(eq)}` : ""}`;
  }
  function stepKey(id){ return `nexus_${eq || "NO_EQ"}_step_${id}`; }

  // TASKS count toward progress/unlock
  const taskSteps=[
    {id:"rif",btn:"rifBtn"},
    {id:"meg",btn:"lvtBtn"},
    {id:"torque",btn:"torqueBtn"},
    {id:"l2",btn:"l2Btn"},
    {id:"prefod",btn:"prefodBtn"},
    {id:"fpv_photo",btn:"finishedPhotoBtn"}
  ];

  // Supporting material ONLY (no completion/progress)
  const refs=[
    {id:"construction",btn:"constructionBtn"},
    {id:"phenolic",btn:"phenolicBtn"},
    {id:"transformer",btn:"transformerBtn"},
    {id:"supporting",btn:"supportingBtn"}
  ];

  [...taskSteps, ...refs].forEach(s=>{
    const el = document.getElementById(s.btn);
    if (el) el.href = link(s.id);
  });

  const fill = document.getElementById("progressFill");
  const txt  = document.getElementById("progressText");
  const cnt  = document.getElementById("progressCount");
  const eBtn = document.getElementById("energizationBtn");

  function energizationHref(){
    return `energization.html${eq ? `?eq=${encodeURIComponent(eq)}` : ""}`;
  }

  function refresh(){
    let done = 0;

    taskSteps.forEach(s=>{
      const el = document.getElementById(s.btn);
      const ok = localStorage.getItem(stepKey(s.id)) === "1";
      if (el) el.classList.toggle("complete", ok);
      if (ok) done++;
    });

    // Refs never show completion
    refs.forEach(s=>{
      const el = document.getElementById(s.btn);
      if (el) el.classList.remove("complete");
    });

    const pct = taskSteps.length ? Math.round((done / taskSteps.length) * 100) : 0;

    if (fill) fill.style.width = `${pct}%`;
    if (txt)  txt.textContent = `Progress: ${pct}%`;
    if (cnt)  cnt.textContent = `${done}/${taskSteps.length}`;

    if (eBtn){
      if (pct >= 100){
        eBtn.classList.remove("locked");
        eBtn.classList.add("unlocked");
        eBtn.href = energizationHref();
        eBtn.style.pointerEvents = "auto";
        eBtn.removeAttribute("aria-disabled");
      } else {
        eBtn.classList.add("locked");
        eBtn.classList.remove("unlocked");
        eBtn.href = "#";
        eBtn.style.pointerEvents = "none";
        eBtn.setAttribute("aria-disabled","true");
      }
    }
  }

  // ===== Goal + Countdown (local + optional Firestore) =====
  const goalDateEl = document.getElementById("goalDate");
  const notifyEmailsEl = document.getElementById("notifyEmails");
  const saveGoalBtn = document.getElementById("saveGoalBtn");
  const clearGoalBtn = document.getElementById("clearGoalBtn");
  const countdownBig = document.getElementById("countdownBig");
  const countdownSub = document.getElementById("countdownSub");

  function goalKey(){ return `nexus_${eq || "NO_EQ"}_energ_goal_iso`; }
  function emailsKey(){ return `nexus_${eq || "NO_EQ"}_energ_goal_emails`; }

  function loadGoalFromLocal(){
    const iso = localStorage.getItem(goalKey()) || "";
    const emails = localStorage.getItem(emailsKey()) || "";
    if (goalDateEl) goalDateEl.value = iso ? iso.slice(0,16) : "";
    if (notifyEmailsEl) notifyEmailsEl.value = emails;
  }

  function setGoalLocal(iso, emails){
    if (iso) localStorage.setItem(goalKey(), iso);
    else localStorage.removeItem(goalKey());
    if (emails) localStorage.setItem(emailsKey(), emails);
    else localStorage.removeItem(emailsKey());
  }

  async function setGoalFirestore(iso, emails){
    try{
      if (!window.NEXUS_FB?.db || !eq) return;
      const { db, auth } = window.NEXUS_FB;

      const { doc, setDoc, serverTimestamp, Timestamp } =
        await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");

      const ref = doc(db, "equipment", eq);

      const dt = iso ? new Date(iso) : null;
      const notifyEmails = (emails || "")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);

      await setDoc(ref, {
        energizationGoalAt: dt ? Timestamp.fromDate(dt) : null,
        energizationNotifyEmails: notifyEmails,
        updatedAt: serverTimestamp(),
        updatedBy: auth?.currentUser?.uid || null
      }, { merge:true });
    }catch(e){
      console.warn("Firestore goal save failed:", e);
    }
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function renderCountdown(){
    if (!countdownBig || !countdownSub) return;

    const iso = localStorage.getItem(goalKey());
    if (!iso){
      countdownBig.textContent = "No goal set";
      countdownSub.textContent = "";
      return;
    }

    const target = new Date(iso).getTime();
    const now = Date.now();
    let diff = target - now;

    const past = diff < 0;
    diff = Math.abs(diff);

    const days = Math.floor(diff / (24*3600*1000));
    const hrs  = Math.floor((diff % (24*3600*1000)) / (3600*1000));
    const mins = Math.floor((diff % (3600*1000)) / (60*1000));
    const secs = Math.floor((diff % (60*1000)) / 1000);

    countdownBig.textContent =
      (past ? "Past due by: " : "Time remaining: ") +
      `${days}d ${pad2(hrs)}h ${pad2(mins)}m ${pad2(secs)}s`;

    countdownSub.textContent = `Goal: ${new Date(iso).toLocaleString()}`;
  }

  let countdownTimer = null;
  function startCountdown(){
    if (countdownTimer) clearInterval(countdownTimer);
    renderCountdown();
    countdownTimer = setInterval(renderCountdown, 1000);
  }

  if (saveGoalBtn){
    saveGoalBtn.addEventListener("click", async () => {
      if (!eq) return;

      const raw = (goalDateEl?.value || "").trim(); // "YYYY-MM-DDTHH:mm"
      const emails = (notifyEmailsEl?.value || "").trim();
      const iso = raw ? new Date(raw).toISOString() : "";

      setGoalLocal(iso, emails);
      await setGoalFirestore(iso, emails);
      startCountdown();
    });
  }

  if (clearGoalBtn){
    clearGoalBtn.addEventListener("click", async () => {
      setGoalLocal("", "");
      if (goalDateEl) goalDateEl.value = "";
      if (notifyEmailsEl) notifyEmailsEl.value = "";
      await setGoalFirestore("", "");
      startCountdown();
    });
  }

  // Initial UI
  refresh();
  loadGoalFromLocal();
  startCountdown();

  // Local refresh triggers
  window.addEventListener("focus", () => { refresh(); renderCountdown(); });
  window.addEventListener("pageshow", () => { refresh(); renderCountdown(); });
  window.addEventListener("storage", () => { refresh(); renderCountdown(); });

  // =========================
  // FIREBASE REAL-TIME SYNC (optional)
  // - Steps: equipment/{eq}/steps/{stepId} => mirrors into localStorage
  // - Goal: equipment/{eq} doc fields => mirrors into localStorage
  // =========================
  let fbStepsUnsub = null;

  async function startFirestoreStepsListener(){
    try{
      if (!eq || !window.NEXUS_FB?.db) return;
      const { db } = window.NEXUS_FB;

      const { collection, onSnapshot } =
        await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");

      const stepsCol = collection(db, "equipment", eq, "steps");
      const knownTaskIds = new Set(taskSteps.map(s => s.id));

      fbStepsUnsub = onSnapshot(stepsCol, (snap) => {
        snap.forEach(docSnap => {
          const stepId = docSnap.id;
          if (!knownTaskIds.has(stepId)) return; // tasks only drive progress/unlock

          const data = docSnap.data() || {};
          if (data.done) localStorage.setItem(stepKey(stepId), "1");
          else localStorage.removeItem(stepKey(stepId));
        });

        refresh();
      });
    }catch(e){
      console.warn("Firestore steps listener failed:", e);
    }
  }

  async function startFirestoreGoalListener(){
    try{
      if (!eq || !window.NEXUS_FB?.db) return;
      const { db } = window.NEXUS_FB;

      const { doc, onSnapshot } =
        await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");

      const ref = doc(db, "equipment", eq);

      onSnapshot(ref, (snap) => {
        if (!snap.exists()) return;
        const data = snap.data() || {};

        const ts = data.energizationGoalAt;
        const iso = ts?.toDate ? ts.toDate().toISOString() : "";

        const emailsArr = Array.isArray(data.energizationNotifyEmails) ? data.energizationNotifyEmails : [];
        const emails = emailsArr.join(", ");

        setGoalLocal(iso, emails);
        loadGoalFromLocal();
        startCountdown();
      });
    }catch(e){
      console.warn("Firestore goal listener failed:", e);
    }
  }

  startFirestoreStepsListener();
  startFirestoreGoalListener();

  window.addEventListener("beforeunload", () => {
    try{ if (fbStepsUnsub) fbStepsUnsub(); }catch(e){}
  });
})();
</script>
</body>
</html>
