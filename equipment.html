<!-- =========================
     equipment.html
     + Progress bar (0–100%)
     + Energization tab (unlocks at 100%)
     + “Bubble” group for: Construction Check Sheet, Phenolic Display, Diagram Image, Supporting Documents
     + Rename “Transformer Image” -> “Diagram Image” (no id/format changes)
     ========================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Equipment</title>

<style>
  :root{
    --bg:#b60000;
    --panel:rgba(255,255,255,0.25);
    --btn-bg:#ffffffdd;
    --btn-color:#000;
    --btn-hover-bg:#fff;
    --btn-hover-color:#b60000;
  }
  html,body{ margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:var(--bg); }
  .page-wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:40px; }
  main.container{
    width:100%; max-width:960px; background:var(--panel); padding:28px; border-radius:18px;
    backdrop-filter: blur(6px); text-align:center;
  }
  h1{ margin:0 0 8px; font-size:34px; }
  .eq{ font-size:20px; font-weight:900; margin:0 0 18px; }

  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }

  .btn{
    width:100%; height:60px; background:var(--btn-bg); color:var(--btn-color);
    border:2px solid #ff0000; border-radius:12px; font-size:15px; font-weight:700;
    cursor:pointer; display:inline-flex; justify-content:center; align-items:center;
    text-decoration:none; transition:0.2s; box-shadow:0 0 12px #ff0000;
  }
  .btn:hover{ background:var(--btn-hover-bg); color:var(--btn-hover-color); transform:translateY(-2px); }

  /* Completed step state (neon green) */
  .btn.complete{
    background:#00ff66 !important;
    color:#002b14 !important;
    border-color:#00ff66 !important;
    box-shadow:0 0 14px rgba(0,255,102,.85) !important;
  }

  /* Locked state (energization) */
  .btn.locked{
    opacity:0.55;
    cursor:not-allowed;
    transform:none !important;
  }

  /* ===== Progress Bar ===== */
  .progress-wrap{
    margin: 10px 0 14px;
    text-align:left;
  }
  .progress-label{
    font-weight:900;
    margin: 0 0 8px;
    display:flex;
    justify-content:space-between;
    gap:10px;
  }
  .progress-track{
    width:100%;
    height:16px;
    border-radius:999px;
    background: rgba(0,0,0,0.28);
    border:1px solid rgba(255,255,255,0.22);
    overflow:hidden;
  }
  .progress-fill{
    height:100%;
    width:0%;
    background:#00ff66;
    box-shadow:0 0 12px rgba(0,255,102,.75);
    transition: width .25s ease;
  }

  /* ===== Energization tab area ===== */
  .top-actions{
    margin: 12px 0 22px;
    display:flex;
    justify-content:center;
    gap:12px;
    flex-wrap:wrap;
  }
  .tab-btn{
    width:auto;
    padding:0 18px;
    height:46px;
    border-radius:999px;
    font-size:14px;
  }

  /* ===== Bubble group under tasks ===== */
  .bubble{
    margin-top:18px;
    padding:16px;
    border-radius:18px;
    background: rgba(0,0,0,0.18);
    border:1px solid rgba(255,255,255,0.20);
    text-align:left;
  }
  .bubble-title{
    font-weight:900;
    margin:0 0 12px;
    letter-spacing:0.02em;
  }
  .bubble-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }
  .bubble .btn{
    height:54px; /* slightly smaller but same format */
  }
</style>
</head>

<body>
<div class="page-wrap">
<main class="container">

  <h1>Equipment Page</h1>
  <div class="eq" id="eqLabel"></div>

  <!-- Progress bar -->
  <div class="progress-wrap">
    <div class="progress-label">
      <div id="progressText">Progress: 0%</div>
      <div id="progressCount">0/0</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Energization tab (unlocks at 100%) -->
  <div class="top-actions">
    <a class="btn tab-btn locked" id="energizationBtn" href="#" aria-disabled="true" title="Complete all steps to unlock">
      Energization
    </a>
  </div>

  <!-- Main task buttons -->
  <div class="grid">
    <a class="btn" id="rifBtn" href="#">RIF</a>
    <a class="btn" id="lvtBtn" href="#">Megohmmeter Testing</a>
    <a class="btn" id="torqueBtn" href="#">Torque</a>
    <a class="btn" id="l2Btn" href="#">L2-IVF</a>
    <a class="btn" id="prefodBtn" href="#">Pre-FOD</a>
    <a class="btn" id="finishedPhotoBtn" href="#">Finished Product Verification Photo</a>
  </div>

  <!-- Bubble group (moved items) -->
  <div class="bubble">
    <div class="bubble-title">Reference &amp; Check Sheets</div>
    <div class="bubble-grid">
      <a class="btn" id="constructionBtn" href="#">Construction Check Sheet</a>
      <a class="btn" id="phenolicBtn" href="#">Phenolic Display</a>
      <!-- Renamed label only; id/stepId unchanged -->
      <a class="btn" id="transformerBtn" href="#">Diagram Image</a>
      <a class="btn" id="supportingBtn" href="#">Supporting Documents</a>
    </div>
  </div>

</main>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const eq = (qs.get("eq") || "").trim();

  document.title = eq ? `Equipment ${eq}` : "Equipment";
  document.getElementById("eqLabel").textContent = eq ? `Equipment: ${eq}` : "Missing equipment ID (eq)";

  function link(id){
    return `task.html?id=${encodeURIComponent(id)}${eq ? `&eq=${encodeURIComponent(eq)}` : ""}`;
  }

  // Energization link (set your target page here)
  function energizationLink(){
    // Change to energization.html when you create it
    return `energization.html${eq ? `?eq=${encodeURIComponent(eq)}` : ""}`;
  }

  // All steps that count toward 100% (includes the bubble items)
  const steps = [
    { btnId: "rifBtn",           stepId: "rif" },
    { btnId: "lvtBtn",           stepId: "meg" },
    { btnId: "torqueBtn",        stepId: "torque" },
    { btnId: "l2Btn",            stepId: "l2" },
    { btnId: "prefodBtn",        stepId: "prefod" },
    { btnId: "phenolicBtn",      stepId: "phenolic" },
    { btnId: "transformerBtn",   stepId: "transformer" }, // label changed to Diagram Image
    { btnId: "finishedPhotoBtn", stepId: "fpv_photo" },
    { btnId: "supportingBtn",    stepId: "supporting" },
    { btnId: "constructionBtn",  stepId: "construction" },
  ];

  // Set all button hrefs
  steps.forEach(({btnId, stepId}) => {
    const el = document.getElementById(btnId);
    if (el) el.href = link(stepId);
  });

  function stepKey(stepId){
    return `nexus_${eq || "NO_EQ"}_step_${stepId}`;
  }
  function landingKey(){
    return `nexus_${eq || "NO_EQ"}_landing_complete`;
  }

  // Progress elements
  const progressFill = document.getElementById("progressFill");
  const progressText = document.getElementById("progressText");
  const progressCount = document.getElementById("progressCount");

  // Energization
  const energizationBtn = document.getElementById("energizationBtn");

  function computeProgress(){
    const total = steps.length;
    let doneCount = 0;

    steps.forEach(({stepId}) => {
      if (localStorage.getItem(stepKey(stepId)) === "1") doneCount++;
    });

    const pct = total ? Math.round((doneCount / total) * 100) : 0;
    return { pct, doneCount, total };
  }

  function refreshProgressBar(){
    const { pct, doneCount, total } = computeProgress();
    progressFill.style.width = `${pct}%`;
    progressText.textContent = `Progress: ${pct}%`;
    progressCount.textContent = `${doneCount}/${total}`;
    return pct;
  }

  function refreshEnergization(pct){
    if (!energizationBtn) return;

    if (pct >= 100){
      energizationBtn.classList.remove("locked");
      energizationBtn.removeAttribute("aria-disabled");
      energizationBtn.title = "";
      energizationBtn.href = energizationLink();
      energizationBtn.style.pointerEvents = "auto";
    } else {
      energizationBtn.classList.add("locked");
      energizationBtn.setAttribute("aria-disabled", "true");
      energizationBtn.title = "Complete all steps to unlock";
      energizationBtn.href = "#";
      energizationBtn.style.pointerEvents = "none";
    }
  }

  function refreshCompletionUI(){
    let anyComplete = false;

    steps.forEach(({btnId, stepId}) => {
      const el = document.getElementById(btnId);
      if (!el) return;

      const done = localStorage.getItem(stepKey(stepId)) === "1";
      el.classList.toggle("complete", done);
      if (done) anyComplete = true;
    });

    localStorage.setItem(landingKey(), anyComplete ? "1" : "0");

    const pct = refreshProgressBar();
    refreshEnergization(pct);
  }

  refreshCompletionUI();
  window.addEventListener("focus", refreshCompletionUI);
  window.addEventListener("pageshow", refreshCompletionUI);

  window.addEventListener("storage", (e) => {
    if (!e.key) return;
    const prefix = `nexus_${eq || "NO_EQ"}_step_`;
    if (e.key.startsWith(prefix) || e.key === landingKey()){
      refreshCompletionUI();
    }
  });
</script>
</body>
</html>
