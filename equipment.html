<!-- =========================
     equipment.html
     FINAL DROP-IN (realistic lightning on unlocked Energization)
     ========================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Equipment</title>

<style>
  :root{
    --bg:#b60000;
    --panel:rgba(255,255,255,0.25);
    --btn-bg:#ffffffdd;
    --btn-color:#000;
    --btn-hover-bg:#fff;
    --btn-hover-color:#b60000;
  }
  html,body{ margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:var(--bg); }
  .page-wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:40px; }
  main.container{
    width:100%; max-width:960px; background:var(--panel); padding:28px; border-radius:18px;
    backdrop-filter: blur(6px); text-align:center;
  }
  h1{ margin:0 0 8px; font-size:34px; }
  .eq{ font-size:20px; font-weight:900; margin:0 0 18px; }

  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }

  .btn{
    width:100%; height:60px; background:var(--btn-bg); color:var(--btn-color);
    border:2px solid #ff0000; border-radius:12px; font-size:15px; font-weight:700;
    cursor:pointer; display:inline-flex; justify-content:center; align-items:center;
    text-decoration:none; transition:0.2s; box-shadow:0 0 12px #ff0000;
    position:relative;
  }
  .btn:hover{ background:var(--btn-hover-bg); color:var(--btn-hover-color); transform:translateY(-2px); }

  .btn.complete{
    background:#00ff66 !important;
    color:#002b14 !important;
    border-color:#00ff66 !important;
    box-shadow:0 0 14px rgba(0,255,102,.85) !important;
  }

  .btn.locked{
    opacity:0.55;
    cursor:not-allowed;
    transform:none !important;
  }

  /* ===== Progress Bar ===== */
  .progress-wrap{ margin:10px 0 14px; text-align:left; }
  .progress-label{
    font-weight:900;
    margin:0 0 8px;
    display:flex;
    justify-content:space-between;
  }
  .progress-track{
    width:100%;
    height:16px;
    border-radius:999px;
    background:rgba(0,0,0,0.28);
    border:1px solid rgba(255,255,255,0.22);
    overflow:hidden;
  }
  .progress-fill{
    height:100%;
    width:0%;
    background:#00ff66;
    box-shadow:0 0 12px rgba(0,255,102,.75);
    transition:width .25s ease;
  }

  /* ===== Bubble ===== */
  .bubble{
    margin-top:18px;
    padding:16px;
    border-radius:18px;
    background:rgba(0,0,0,0.18);
    border:1px solid rgba(255,255,255,0.20);
    text-align:left;
  }
  .bubble-title{ font-weight:900; margin:0 0 12px; }
  .bubble-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }
  .bubble .btn{ height:54px; }

  /* =========================
     Energization (Realistic Lightning)
     ========================= */
  #energizationBtn{
    height:72px;               /* larger */
    font-size:18px;
    font-weight:900;
    padding:0 30px;
    border-radius:14px;
    overflow:hidden;
  }

  /* Unlocked base */
  #energizationBtn.unlocked{
    background:#00ff66 !important;
    color:#002b14 !important;
    border-color:#00ff66 !important;
    box-shadow:
      0 0 18px rgba(0,255,102,.95),
      0 0 42px rgba(0,255,102,.70);
    animation:energizeGlow 1.6s infinite ease-in-out;
  }

  /* Electric arcs layer 1 */
  #energizationBtn.unlocked::before{
    content:"";
    position:absolute;
    inset:-30%;
    background:
      linear-gradient(90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,.90) 8%,
        rgba(120,255,190,.65) 12%,
        rgba(255,255,255,0) 18%,
        rgba(255,255,255,0) 100%
      );
    transform:rotate(-10deg) translateX(-120%);
    opacity:0.0;
    filter:blur(0.2px);
    mix-blend-mode:screen;
    animation:arcSweep 0.75s infinite steps(2,end);
    pointer-events:none;
  }

  /* Electric arcs layer 2 (different angle/speed) */
  #energizationBtn.unlocked::after{
    content:"";
    position:absolute;
    inset:-35%;
    background:
      linear-gradient(90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,.85) 10%,
        rgba(120,255,190,.55) 14%,
        rgba(255,255,255,0) 22%,
        rgba(255,255,255,0) 100%
      );
    transform:rotate(12deg) translateX(-120%);
    opacity:0.0;
    filter:blur(0.6px);
    mix-blend-mode:screen;
    animation:arcSweep2 1.05s infinite steps(3,end);
    pointer-events:none;
  }

  /* Inner “spark” cracks (adds jaggedness) */
  #energizationBtn.unlocked .sparkline{
    position:absolute;
    inset:0;
    pointer-events:none;
  }
  #energizationBtn.unlocked .sparkline::before,
  #energizationBtn.unlocked .sparkline::after{
    content:"";
    position:absolute;
    left:12%;
    right:12%;
    top:50%;
    height:2px;
    background:rgba(255,255,255,.85);
    box-shadow:0 0 10px rgba(255,255,255,.8);
    transform:translateY(-50%) skewX(-20deg);
    opacity:0;
    animation:sparkFlicker 0.35s infinite steps(2,end);
  }
  #energizationBtn.unlocked .sparkline::after{
    top:62%;
    left:18%;
    right:18%;
    opacity:0;
    filter:blur(0.3px);
    animation-duration:0.42s;
    animation-delay:0.12s;
  }

  @keyframes energizeGlow{
    0%   { box-shadow:0 0 14px rgba(0,255,102,.80), 0 0 34px rgba(0,255,102,.55); }
    50%  { box-shadow:0 0 22px rgba(0,255,102,1.00), 0 0 52px rgba(0,255,102,.80); }
    100% { box-shadow:0 0 14px rgba(0,255,102,.80), 0 0 34px rgba(0,255,102,.55); }
  }

  /* Fast sweep + flicker (layer 1) */
  @keyframes arcSweep{
    0%   { opacity:0; transform:rotate(-10deg) translateX(-140%); }
    10%  { opacity:1; }
    35%  { opacity:0.85; }
    55%  { opacity:0.2; }
    80%  { opacity:0.9; }
    100% { opacity:0; transform:rotate(-10deg) translateX(140%); }
  }

  /* Slower sweep (layer 2) */
  @keyframes arcSweep2{
    0%   { opacity:0; transform:rotate(12deg) translateX(-150%); }
    15%  { opacity:0.9; }
    40%  { opacity:0.25; }
    60%  { opacity:0.8; }
    100% { opacity:0; transform:rotate(12deg) translateX(150%); }
  }

  /* Random-ish spark flicker using steps */
  @keyframes sparkFlicker{
    0%   { opacity:0; transform:translateY(-50%) skewX(-20deg) scaleX(0.6); }
    25%  { opacity:1; transform:translateY(-50%) skewX(-18deg) scaleX(1); }
    50%  { opacity:0.2; transform:translateY(-50%) skewX(-26deg) scaleX(0.9); }
    75%  { opacity:1; transform:translateY(-50%) skewX(-14deg) scaleX(1.05); }
    100% { opacity:0; transform:translateY(-50%) skewX(-22deg) scaleX(0.7); }
  }
</style>
</head>

<body>
<div class="page-wrap">
<main class="container">

  <h1>Equipment Page</h1>
  <div class="eq" id="eqLabel"></div>

  <div class="progress-wrap">
    <div class="progress-label">
      <div id="progressText">Progress: 0%</div>
      <div id="progressCount">0/0</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <div style="margin:12px 0 22px;">
    <a class="btn locked" id="energizationBtn" href="#" aria-disabled="true">
      Energization
      <!-- extra layer for crackle lines when unlocked -->
      <span class="sparkline" aria-hidden="true"></span>
    </a>
  </div>

  <div class="grid">
    <a class="btn" id="rifBtn">RIF</a>
    <a class="btn" id="lvtBtn">Megohmmeter Testing</a>
    <a class="btn" id="torqueBtn">Torque</a>
    <a class="btn" id="l2Btn">L2-IVF</a>
    <a class="btn" id="prefodBtn">Pre-FOD</a>
    <a class="btn" id="finishedPhotoBtn">Finished Product Verification Photo</a>
  </div>

  <div class="bubble">
    <div class="bubble-title">Reference &amp; Check Sheets</div>
    <div class="bubble-grid">
      <a class="btn" id="constructionBtn">Construction Check Sheet</a>
      <a class="btn" id="phenolicBtn">Phenolic Display</a>
      <a class="btn" id="transformerBtn">Diagram Image</a>
      <a class="btn" id="supportingBtn">Supporting Documents</a>
    </div>
  </div>

</main>
</div>

<script>
const qs=new URLSearchParams(location.search);
const eq=(qs.get("eq")||"").trim();
document.getElementById("eqLabel").textContent=eq?`Equipment: ${eq}`:"Missing equipment ID";

function link(id){return`task.html?id=${encodeURIComponent(id)}${eq?`&eq=${encodeURIComponent(eq)}`:""}`;}
function stepKey(id){return`nexus_${eq||"NO_EQ"}_step_${id}`;}

const taskSteps=[
  {id:"rif",btn:"rifBtn"},
  {id:"meg",btn:"lvtBtn"},
  {id:"torque",btn:"torqueBtn"},
  {id:"l2",btn:"l2Btn"},
  {id:"prefod",btn:"prefodBtn"},
  {id:"fpv_photo",btn:"finishedPhotoBtn"}
];

const refs=[
  {id:"construction",btn:"constructionBtn"},
  {id:"phenolic",btn:"phenolicBtn"},
  {id:"transformer",btn:"transformerBtn"},
  {id:"supporting",btn:"supportingBtn"}
];

[...taskSteps,...refs].forEach(s=>{
  const el=document.getElementById(s.btn);
  if(el) el.href=link(s.id);
});

const fill=document.getElementById("progressFill");
const txt=document.getElementById("progressText");
const cnt=document.getElementById("progressCount");
const eBtn=document.getElementById("energizationBtn");

function refresh(){
  let done=0;
  taskSteps.forEach(s=>{
    const el=document.getElementById(s.btn);
    const ok=localStorage.getItem(stepKey(s.id))==="1";
    el.classList.toggle("complete",ok);
    if(ok) done++;
  });

  // Reference buttons never show as complete
  refs.forEach(s=>{
    const el=document.getElementById(s.btn);
    if(el) el.classList.remove("complete");
  });

  const pct=Math.round((done/taskSteps.length)*100);
  fill.style.width=`${pct}%`;
  txt.textContent=`Progress: ${pct}%`;
  cnt.textContent=`${done}/${taskSteps.length}`;

  if(pct===100){
    eBtn.classList.remove("locked");
    eBtn.classList.add("unlocked");
    eBtn.href=`energization.html${eq?`?eq=${encodeURIComponent(eq)}`:""}`;
    eBtn.style.pointerEvents="auto";
    eBtn.removeAttribute("aria-disabled");
  }else{
    eBtn.classList.add("locked");
    eBtn.classList.remove("unlocked");
    eBtn.href="#";
    eBtn.style.pointerEvents="none";
    eBtn.setAttribute("aria-disabled","true");
  }
}

refresh();
window.addEventListener("focus",refresh);
window.addEventListener("storage",refresh);
window.addEventListener("pageshow",refresh);
</script>
</body>
</html>
