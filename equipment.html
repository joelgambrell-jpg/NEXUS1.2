<!-- =========================
     equipment.html
     DROP-IN REPLACEMENT
     - Energization button half-size
     - Lightning bolts radiate outward around it while unlocked
     ========================= -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Equipment</title>

<style>
  :root{
    --bg:#b60000;
    --panel:rgba(255,255,255,0.25);
    --btn-bg:#ffffffdd;
    --btn-color:#000;
    --btn-hover-bg:#fff;
    --btn-hover-color:#b60000;
  }
  html,body{ margin:0; font-family:Arial,Helvetica,sans-serif; color:#fff; background:var(--bg); }
  .page-wrap{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:40px; }
  main.container{
    width:100%; max-width:960px; background:var(--panel); padding:28px; border-radius:18px;
    backdrop-filter: blur(6px); text-align:center;
  }
  h1{ margin:0 0 8px; font-size:34px; }
  .eq{ font-size:20px; font-weight:900; margin:0 0 18px; }

  .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }

  .btn{
    width:100%; height:60px; background:var(--btn-bg); color:var(--btn-color);
    border:2px solid #ff0000; border-radius:12px; font-size:15px; font-weight:700;
    cursor:pointer; display:inline-flex; justify-content:center; align-items:center;
    text-decoration:none; transition:0.2s; box-shadow:0 0 12px #ff0000;
    position:relative;
  }
  .btn:hover{ background:var(--btn-hover-bg); color:var(--btn-hover-color); transform:translateY(-2px); }

  .btn.complete{
    background:#00ff66 !important;
    color:#002b14 !important;
    border-color:#00ff66 !important;
    box-shadow:0 0 14px rgba(0,255,102,.85) !important;
  }

  .btn.locked{
    opacity:0.55;
    cursor:not-allowed;
    transform:none !important;
  }

  /* ===== Progress Bar ===== */
  .progress-wrap{ margin:10px 0 14px; text-align:left; }
  .progress-label{
    font-weight:900;
    margin:0 0 8px;
    display:flex;
    justify-content:space-between;
  }
  .progress-track{
    width:100%;
    height:16px;
    border-radius:999px;
    background:rgba(0,0,0,0.28);
    border:1px solid rgba(255,255,255,0.22);
    overflow:hidden;
  }
  .progress-fill{
    height:100%;
    width:0%;
    background:#00ff66;
    box-shadow:0 0 12px rgba(0,255,102,.75);
    transition:width .25s ease;
  }

  /* ===== Bubble ===== */
  .bubble{
    margin-top:18px;
    padding:16px;
    border-radius:18px;
    background:rgba(0,0,0,0.18);
    border:1px solid rgba(255,255,255,0.20);
    text-align:left;
  }
  .bubble-title{ font-weight:900; margin:0 0 12px; }
  .bubble-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }
  .bubble .btn{ height:54px; }

  /* =========================
     Energization (Half-size + Radiating Lightning)
     ========================= */
  #energizationWrap{
    position:relative;
    display:inline-block;
    margin:12px 0 22px;
  }

  /* "Half size" compared to previous 72px: use 44px height + smaller padding/font */
  #energizationBtn{
    width:auto;
    height:44px;
    padding:0 14px;
    font-size:14px;
    font-weight:900;
    border-radius:999px;
    overflow:visible; /* allow lightning to radiate out */
    z-index:2;
  }

  #energizationBtn.unlocked{
    background:#00ff66 !important;
    color:#002b14 !important;
    border-color:#00ff66 !important;
    box-shadow:
      0 0 14px rgba(0,255,102,.95),
      0 0 28px rgba(0,255,102,.70);
    animation:energizeGlow 1.6s infinite ease-in-out;
  }

  @keyframes energizeGlow{
    0%   { box-shadow:0 0 10px rgba(0,255,102,.80), 0 0 22px rgba(0,255,102,.55); }
    50%  { box-shadow:0 0 16px rgba(0,255,102,1.00), 0 0 34px rgba(0,255,102,.80); }
    100% { box-shadow:0 0 10px rgba(0,255,102,.80), 0 0 22px rgba(0,255,102,.55); }
  }

  /* Radiating lightning container (hidden unless unlocked) */
  .radiate{
    position:absolute;
    inset:0;
    pointer-events:none;
    z-index:1;
    display:none;
  }
  #energizationBtn.unlocked + .radiate{ display:block; }

  /* Each bolt */
  .bolt{
    position:absolute;
    left:50%;
    top:50%;
    width:2px;
    height:18px;
    background:rgba(255,255,255,.92);
    box-shadow:0 0 10px rgba(255,255,255,.85);
    transform-origin: 50% 100%;
    opacity:0;
    filter:blur(0.2px);
  }

  /* Jagged look via pseudo segments */
  .bolt::before,
  .bolt::after{
    content:"";
    position:absolute;
    left:-1px;
    width:4px;
    height:6px;
    background:rgba(255,255,255,.85);
    transform:skewX(-22deg);
    box-shadow:0 0 8px rgba(255,255,255,.6);
  }
  .bolt::before{ top:5px; }
  .bolt::after{ top:11px; opacity:.75; }

  /* Radiate animation: spawn at button edge then shoot outward and fade */
  @keyframes radiateOut{
    0%   { opacity:0; transform:translate(-50%,-50%) rotate(var(--a)) translateY(0) scaleY(0.5); }
    12%  { opacity:1; }
    55%  { opacity:.9; transform:translate(-50%,-50%) rotate(var(--a)) translateY(calc(-1 * var(--d))) scaleY(1.2); }
    100% { opacity:0; transform:translate(-50%,-50%) rotate(var(--a)) translateY(calc(-1 * (var(--d) + 18px))) scaleY(1.5); }
  }

  /* Staggered bolts around the button */
  .b1 { --a:  0deg;  --d: 22px; animation:radiateOut 1.05s infinite ease-out; }
  .b2 { --a: 45deg;  --d: 24px; animation:radiateOut 1.15s infinite ease-out .10s; }
  .b3 { --a: 90deg;  --d: 22px; animation:radiateOut 1.00s infinite ease-out .20s; }
  .b4 { --a:135deg;  --d: 24px; animation:radiateOut 1.20s infinite ease-out .05s; }
  .b5 { --a:180deg;  --d: 22px; animation:radiateOut 1.10s infinite ease-out .18s; }
  .b6 { --a:225deg;  --d: 24px; animation:radiateOut 1.25s infinite ease-out .28s; }
  .b7 { --a:270deg;  --d: 22px; animation:radiateOut 1.05s infinite ease-out .14s; }
  .b8 { --a:315deg;  --d: 24px; animation:radiateOut 1.18s infinite ease-out .24s; }
</style>
</head>

<body>
<div class="page-wrap">
<main class="container">

  <h1>Equipment Page</h1>
  <div class="eq" id="eqLabel"></div>

  <div class="progress-wrap">
    <div class="progress-label">
      <div id="progressText">Progress: 0%</div>
      <div id="progressCount">0/0</div>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Energization (small) + radiating bolts when unlocked -->
  <div id="energizationWrap">
    <a class="btn locked" id="energizationBtn" href="#" aria-disabled="true">Energization</a>

    <div class="radiate" aria-hidden="true">
      <span class="bolt b1"></span>
      <span class="bolt b2"></span>
      <span class="bolt b3"></span>
      <span class="bolt b4"></span>
      <span class="bolt b5"></span>
      <span class="bolt b6"></span>
      <span class="bolt b7"></span>
      <span class="bolt b8"></span>
    </div>
  </div>

  <div class="grid">
    <a class="btn" id="rifBtn">RIF</a>
    <a class="btn" id="lvtBtn">Megohmmeter Testing</a>
    <a class="btn" id="torqueBtn">Torque</a>
    <a class="btn" id="l2Btn">L2-IVF</a>
    <a class="btn" id="prefodBtn">Pre-FOD</a>
    <a class="btn" id="finishedPhotoBtn">Finished Product Verification Photo</a>
  </div>

  <div class="bubble">
    <div class="bubble-title">Reference &amp; Check Sheets</div>
    <div class="bubble-grid">
      <a class="btn" id="constructionBtn">Construction Check Sheet</a>
      <a class="btn" id="phenolicBtn">Phenolic Display</a>
      <a class="btn" id="transformerBtn">Diagram Image</a>
      <a class="btn" id="supportingBtn">Supporting Documents</a>
    </div>
  </div>

</main>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const eq = (qs.get("eq") || "").trim();
  document.getElementById("eqLabel").textContent = eq ? `Equipment: ${eq}` : "Missing equipment ID";

  function link(id){
    return `task.html?id=${encodeURIComponent(id)}${eq ? `&eq=${encodeURIComponent(eq)}` : ""}`;
  }
  function stepKey(id){
    return `nexus_${eq || "NO_EQ"}_step_${id}`;
  }

  const taskSteps = [
    {id:"rif",btn:"rifBtn"},
    {id:"meg",btn:"lvtBtn"},
    {id:"torque",btn:"torqueBtn"},
    {id:"l2",btn:"l2Btn"},
    {id:"prefod",btn:"prefodBtn"},
    {id:"fpv_photo",btn:"finishedPhotoBtn"}
  ];

  const refs = [
    {id:"construction",btn:"constructionBtn"},
    {id:"phenolic",btn:"phenolicBtn"},
    {id:"transformer",btn:"transformerBtn"},
    {id:"supporting",btn:"supportingBtn"}
  ];

  [...taskSteps, ...refs].forEach(s => {
    const el = document.getElementById(s.btn);
    if (el) el.href = link(s.id);
  });

  const fill = document.getElementById("progressFill");
  const txt  = document.getElementById("progressText");
  const cnt  = document.getElementById("progressCount");
  const eBtn = document.getElementById("energizationBtn");

  function refresh(){
    let done = 0;

    taskSteps.forEach(s => {
      const el = document.getElementById(s.btn);
      const ok = localStorage.getItem(stepKey(s.id)) === "1";
      el.classList.toggle("complete", ok);
      if (ok) done++;
    });

    // References never show complete
    refs.forEach(s => {
      const el = document.getElementById(s.btn);
      if (el) el.classList.remove("complete");
    });

    const pct = Math.round((done / taskSteps.length) * 100);
    fill.style.width = `${pct}%`;
    txt.textContent = `Progress: ${pct}%`;
    cnt.textContent = `${done}/${taskSteps.length}`;

    if (pct === 100){
      eBtn.classList.remove("locked");
      eBtn.classList.add("unlocked");
      eBtn.href = `energization.html${eq ? `?eq=${encodeURIComponent(eq)}` : ""}`;
      eBtn.style.pointerEvents = "auto";
      eBtn.removeAttribute("aria-disabled");
    } else {
      eBtn.classList.add("locked");
      eBtn.classList.remove("unlocked");
      eBtn.href = "#";
      eBtn.style.pointerEvents = "none";
      eBtn.setAttribute("aria-disabled","true");
    }
  }

  refresh();
  window.addEventListener("focus", refresh);
  window.addEventListener("storage", refresh);
  window.addEventListener("pageshow", refresh);
</script>
</body>
</html>
